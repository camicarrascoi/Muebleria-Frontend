<!-- proveedores.component.html -->

<nav class="navbar">
  <span>Lista Proveedores</span>
</nav>

<div class="acciones">
  <button *ngIf="esAdmin" (click)="abrirFormularioNuevo()">‚ûï Agregar proveedor</button>
</div>

<table *ngIf="proveedores.length > 0" border="1">
  <thead>
    <tr>
      <th>Fecha de Pedido</th>
      <th>Nombre</th>
      <th>Tel√©fono</th>
      <th>Correo</th>
      <th>Direcci√≥n</th>
      <th>Materiales</th>
      <th>Costo Unitario</th>
      <th *ngIf="esAdmin">Acciones</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let proveedor of proveedores">
      <td>{{ proveedor.fechaPedido | date: 'dd/MM/yyyy' }}</td>
      <td>{{ proveedor.nombre }}</td>
      <td>{{ proveedor.telefono }}</td>
      <td>{{ proveedor.correo }}</td>
      <td>{{ proveedor.direccion }}</td>
      <td>
        <ul>
          <li *ngFor="let pm of proveedor.proveedorMateriales">
            {{ pm.material.nombre }} ({{ pm.material.unidadDeMedida }})
          </li>
        </ul>
      </td>
      <td>
        <ul>
          <li *ngFor="let pm of proveedor.proveedorMateriales">
            {{ pm.cantidadSolicitada }} x {{ pm.costoUnitario | currency:'CLP':'symbol':'1.0-0' }}
          </li>
        </ul>
      </td>
      <td *ngIf="esAdmin">
        <div class="acciones-botones">
          <button (click)="editarProveedor(proveedor)">‚úèÔ∏è Editar</button>
          <button (click)="eliminarProveedor(proveedor.id!)">üóëÔ∏è Eliminar</button>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<!-- Formulario -->
<div *ngIf="mostrarFormulario && proveedorSeleccionado as prov" class="formulario-proveedor">
  <h3>{{ prov.id ? 'Editar Proveedor' : 'Agregar Proveedor' }}</h3>
  <form (ngSubmit)="guardarProveedor()" #formProveedor="ngForm" novalidate>

    <!-- Fecha de Pedido -->
    <label>
      Fecha de Pedido:
      <input type="date" [(ngModel)]="prov.fechaPedido" name="fechaPedido" required />
    </label>

    <!-- Nombre (solo letras y espacios) -->
    <label>
      Nombre:
      <input
        type="text" 
        [(ngModel)]="prov.nombre"
        name="nombre"
        required
        pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë ]+$"
        title="Solo letras y espacios"
        oninput="this.value = this.value.replace(/[^A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë ]/g, '')"
      />
    </label>

    <!-- Tel√©fono (solo d√≠gitos) -->
    <label>
      Tel√©fono:
      <input
        type="tel"
        [(ngModel)]="prov.telefono"
        name="telefono"
        required
        minlength="7"
        maxlength="15"
        (keypress)="soloNumeros($event)"
        #telefono="ngModel"
      />
      <div class="error" *ngIf="telefono.invalid && telefono.touched">
        Debe ingresar solo n√∫meros (entre 7 y 15 d√≠gitos).
      </div>
    </label>

    <!-- Correo -->
    <label>
      Correo:
      <input
        type="email"
        [(ngModel)]="prov.correo"
        name="correo"
        required
        pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
        title="Debe ser un correo v√°lido con '@' y dominio"
      />
    </label>

    <!-- Direcci√≥n -->
    <label>
      Direcci√≥n:
      <input
        type="text"
        [(ngModel)]="prov.direccion"
        name="direccion"
        required
      />
    </label>

    <!-- Materiales -->
    <fieldset>
      <legend>Materiales que provee</legend>
      <div
        *ngFor="let pm of prov.proveedorMateriales; let i = index"
        class="material-item"
      >
        <!-- Select de Material -->
     <label>
        Material:
        <select
        [(ngModel)]="pm.material.id"
        name="materialSeleccionado{{ i }}"
        required
        (ngModelChange)="onMaterialChange(i, $event)"
        >
         <option [ngValue]="null" disabled>Seleccione material</option>
         <option *ngFor="let mat of materialesDisponibles" [ngValue]="mat.id">
          {{ mat.nombre }} ({{ mat.unidadDeMedida }})
         </option>
        </select>
      </label>

        <!-- Cantidad -->
        <label>
          Cantidad:
          <input
            type="number"
            [(ngModel)]="pm.cantidadSolicitada"
            name="cantidadSolicitada{{ i }}"
            required
            min="0"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          />
        </label>

        <!-- Costo -->
        <label>
          Costo:
          <input
            type="number"
            [(ngModel)]="pm.costoUnitario"
            name="costo{{ i }}"
            required
            min="0"
          />
        </label>

        <div class="boton-quitar">
          <button type="button" (click)="quitarMaterial(i)">üóëÔ∏è</button>
        </div>
      </div>

      <div class="boton-agregar">
        <button type="button" (click)="agregarMaterial()">‚ûï Agregar material</button>
      </div>
    </fieldset>

    <div class="botones-formulario">
      <button type="submit" [disabled]="formProveedor.invalid">üíæ Guardar</button>
      <button type="button" (click)="cancelarFormulario()">‚ùå Cancelar</button>
    </div>
  </form>
</div>
