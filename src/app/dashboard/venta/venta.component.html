<!-- venta.component.html -->

<!-- Barra de navegación -->
<nav class="navbar">
  <span>Lista Ventas</span>
</nav>

<!-- Acciones: agregar y exportar -->
<div *ngIf="!mostrarFormulario" class="acciones">
  <button *ngIf="esAdmin" (click)="abrirFormularioNuevo()">➕ Agregar venta</button>
  <button (click)="exportarVentasExcel()">📥 Exportar a Excel</button>
</div>

<!-- Tabla de ventas -->
<div *ngIf="!mostrarFormulario && ventas.length > 0">
  <table border="1" class="tabla-ventas">
    <thead>
      <tr>
        <th>Nombre del Mueble</th>
        <th>Fecha</th>
        <th>Total</th>
        <th>Muebles Vendidos</th>
        <th *ngIf="esAdmin">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let v of ventas">
        <td>{{ v.ventaMuebles[0].nombreMueble }}</td> <!-- Usamos nombreMueble -->
        <td>{{ v.fecha | date: 'dd/MM/yyyy' }}</td>
        <td>{{ v.total | currency:'CLP':'symbol' }}</td>
        <td>
          <ul>
            <li *ngFor="let m of v.ventaMuebles">
              {{ m.nombreMueble }} (x{{ m.cantidad }})
            </li>
          </ul>
        </td>
        <td *ngIf="esAdmin">
          <button (click)="editarVenta(v)">✏️</button>
          <button (click)="eliminarVenta(v.id!)">🗑️</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Formulario para agregar/editar venta -->
<div *ngIf="mostrarFormulario && ventaSeleccionada" class="formulario-venta">
  <h3>{{ ventaSeleccionada.id ? 'Editar Venta' : 'Agregar Venta' }}</h3>
  <form [formGroup]="formVenta" (ngSubmit)="guardarVenta()" novalidate>
    @let fecha= formVenta.get('fecha');
    <!-- Campo Fecha -->
    <label for="fecha">Fecha:</label>
    <input id="fecha" name="fecha" type="date" formControlName="fecha" [attr.min]="fechaMinima"
      (ngModelChange)="onFechaChange($event)" required />
    <div *ngIf="fecha?.invalid && fecha?.touched" class="error">
      La fecha es obligatoria.
    </div>
    @let muebleSeleccionadoId= formVenta.get('muebleSeleccionadoId');
    <!-- Selección de Mueble -->
    <label for="mueble">Mueble:</label>
    <select id="mueble" name="muebleSeleccionadoId" formControlName="muebleSeleccionadoId" >
      <option value="" disabled>-- Selecciona un mueble --</option>
      <option *ngFor="let m of mueblesDisponibles" [value]="m.id">
        {{ m.nombre }} (stock: {{ m.stock }})
      </option>
    </select>
    <div *ngIf="muebleSeleccionadoId?.invalid && muebleSeleccionadoId?.touched" class="error">
      Debes elegir un mueble.
    </div>
    @let cantidadSeleccionada= formVenta.get('cantidadSeleccionada');
    <!-- Cantidad -->
    <label for="cantidad">Cantidad:</label>
    <input id="cantidad" name="cantidadSeleccionada" type="number" formControlName="cantidadSeleccionada"
      [attr.max]="stockSeleccionado" />

    <div *ngIf=" cantidadSeleccionada?.invalid && cantidadSeleccionada?.touched" class="error">
      Cantidad inválida.
    </div>

    <!-- Botones -->
    <div class="botones-formulario">
      <button type="submit" [disabled]="formVenta.invalid">Guardar</button>
      <button type="button" (click)="cancelarFormulario()">Cancelar</button>
    </div>

  </form>
</div>